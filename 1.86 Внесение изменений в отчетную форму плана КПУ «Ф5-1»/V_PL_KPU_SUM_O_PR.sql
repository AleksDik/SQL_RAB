CREATE OR REPLACE VIEW V_PL_KPU_SUM_O_PR
(okrug_id, okrug_sh, a77, a78, a1, a2, a3, a4, a5, a6, a7, a8, a9, a10, a11, a12, a13, a14, a15, a16, a17, a18, a19, a20, a21, a22, a23, a24, a25, a26, a27, a28, a29, a30, a31, a32, a33, a34, a35, a36, a37, a38, a39, a40, a41, a42, a43, a44, a45, a46, a47, a48, a49, a50, a51, a52, a53, a54, a55, a56, a57, a58, a59, a60, a61, a62, a63, a64, a65, a66, a67, a68, a69, a70, a71, a72, a73, a74, a75, a76, a79, a80, a81, year, a82, a83, a86, a87, a88, a89, a90, a91, a92, a93, a94, a95, a96, a97, a98, a99, a100, a101, a102, a103, a104, a105, a106, a107, a108, a109, a110, a111, a112, a113, a114, a115, a116, a117, a118, a119, a120, a121, a122, a123, a124, a125, a126, a127, a128, a129, a130, a131, a132, a133, a134, a135, a136, a137, a138, a139, a140, a141, a142, a143, a144, a145, a146, a147, a148, a149, a150, a151, a152, a153, a154, a155, a156, a157, a158, a159, a160, a161, a162, a163, a164, a165, a166, a167, a168, a169, a170, a171, a172, a173, a174, a175, a176, a177, a178, a179, a180, a181, a182, a183, a184, a185, a186, a187, a188, a189, a190, a191, a192, a193, a194, a195, a196, a197, a198, a199, a200, a201, a202, a203, a204, a205, a206, a207, a208, a209, a210, a211, a212, a213, a214, a215, a216, a217, a218, a219, a220, a221, a222, a223, a224, a225, a226, a227, a228, a229, a230, a231, a232, a233,a234)
AS
/* #26.04.2013 Дикан.
   добаквил поле a234 (из V_OKRUG_LIMIT)
  Лимиты по округам для вычисления поля "Выполнение ТЕКУЩЕГО плана в %%" 
  в отчете "План КПУ Ф5-1..." 
*/


SELECT v_pl_kpu_sum_f_pr.okrug_id as okrug_id,
            SUBSTR (get_okrug_sh (v_pl_kpu_sum_f_pr.okrug_id), 1, 200),
            SUBSTR ('Округ:' || RTRIM (get_okrug (v_pl_kpu_sum_f_pr.okrug_id)), 1, 250)
            || CASE
                  WHEN p_par.get_n_param1 IS NOT NULL
                  THEN
                     '; План:'
                     || (SELECT NAME
                           FROM CLASSIFIER_KURS3
                          WHERE     CLASSIFIER_NUM = 101
                                AND ROW_NUM = p_par.get_n_param1
                                AND DELETED = 0)
                  ELSE
                     ''
               END
            || CASE
                  WHEN p_par.get_n_param2 IS NOT NULL
                  THEN
                     '; Приоритет:'
                     || (SELECT SHORT_NAME
                           FROM V_PRIORITET
                          WHERE PRIORITET_ID = p_par.get_n_param2)
                  WHEN p_par.get_n_param3 IS NOT NULL
                  THEN
                     '; Гр.приоритетов:'
                     || (SELECT SHORT_NAME
                           FROM PRIORITY_GROUP
                          WHERE PRIORITY_GROUP_ID = p_par.get_n_param3)
                  ELSE
                     ''
               END                                 ---- УИТ- 21/12 ------- AVB
                  ,
            'На ' || TO_CHAR (SYSDATE, 'dd.mm.yyyy'),
            '',
            '',
            DECODE (
               YEAR,
               2001, DECODE (v_pl_kpu_sum_f_pr.okrug_id,
                             51, 1722,
                             52, 1428,
                             53, 1264,
                             54, 1475,
                             55, 1210,
                             56, 644,
                             57, 916,
                             58, 803,
                             59, 1319,
                             60, 141,
                             0),
               2002, DECODE (v_pl_kpu_sum_f_pr.okrug_id,
                             51, 2049,
                             52, 1590,
                             53, 2668,
                             54, 2243,
                             55, 2130,
                             56, 1361,
                             57, 1838,
                             58, 1058,
                             59, 2110,
                             60, 318,
                             0),
               2003, DECODE (v_pl_kpu_sum_f_pr.okrug_id,
                             51, 940,
                             52, 917,
                             53, 1596,
                             54, 1280,
                             55, 1211,
                             56, 749,
                             57, 1054,
                             58, 526,
                             59, 1191,
                             60, 158,
                             0),
               2004, DECODE (v_pl_kpu_sum_f_pr.okrug_id,
                             51, 517,
                             52, 1102,
                             53, 1332,
                             54, 1000,
                             55, 1340,
                             56, 869,
                             57, 1053,
                             58, 696,
                             59, 1016,
                             60, 176,
                             0)                          -- avl 28.06.2005 нач
                               ,
               2005, DECODE (v_pl_kpu_sum_f_pr.okrug_id,
                             51, 529,
                             52, 1124,
                             53, 1060,
                             54, 1022,
                             55, 1268,
                             56, 871,
                             57, 1040,
                             58, 846,
                             59, 1199,
                             60, 173,
                             0)                          -- avl 28.06.2005 кон
                               ,
               2006, DECODE (v_pl_kpu_sum_f_pr.okrug_id,
                             51, 559,
                             52, 1077,
                             53, 1288,
                             54, 883,
                             55, 1147,
                             56, 749,
                             57, 904,
                             58, 763,
                             59, 1002,
                             60, 143,
                             0),
               2007, DECODE (v_pl_kpu_sum_f_pr.okrug_id,
                             51, 615,
                             52, 1249,
                             53, 1430,
                             54, 1004,
                             55, 1351,
                             56, 829,
                             57, 1138,
                             58, 855,
                             59, 1123,
                             60, 169,
                             0),
               2008, DECODE (v_pl_kpu_sum_f_pr.okrug_id,
                             51, 446,
                             52, 1122,
                             53, 1394,
                             54, 863,
                             55, 1336,
                             56, 679,
                             57, 849,
                             58, 717,
                             59, 798,
                             60, 158,
                             0),
               2010, DECODE (v_pl_kpu_sum_f_pr.okrug_id,
                             51, 405,
                             52, 1291,
                             53, 1427,
                             54, 859,
                             55, 1549,
                             56, 898,
                             57, 709,
                             58, 712,
                             59, 878,
                             60, 211,
                             0),
               0),
            DECODE (
               YEAR,
               2001, DECODE (v_pl_kpu_sum_f_pr.okrug_id,
                             51, 4255,
                             52, 4818,
                             53, 4127,
                             54, 4079,
                             55, 3946,
                             56, 2301,
                             57, 2942,
                             58, 2585,
                             59, 4294,
                             60, 464,
                             0),
               2002, DECODE (v_pl_kpu_sum_f_pr.okrug_id,
                             51, 4362,
                             52, 3951,
                             53, 6626,
                             54, 5869,
                             55, 5631,
                             56, 4412,
                             57, 4325,
                             58, 2419,
                             59, 6170,
                             60, 786,
                             0),
               2008, DECODE (v_pl_kpu_sum_f_pr.okrug_id,
                             51, 1339,
                             52, 3367,
                             53, 4183,
                             54, 2589,
                             55, 4009,
                             56, 2036,
                             57, 2546,
                             58, 2152,
                             59, 2393,
                             60, 473,
                             0),
               0),
            SUM (a5),
            SUM (a6),
            SUM (a7),
            SUM (a8),
            SUM (a9),
            SUM (a10),
            SUM (a11),
            SUM (a12),
            SUM (a13),
            SUM (a14),
            SUM (a15),
            SUM (a16),
            SUM (a17),
            SUM (a18),
            SUM (a19),
            SUM (a20),
            SUM (a21),
            SUM (a22),
            SUM (a23),
            SUM (a24),
            SUM (a25),
            SUM (a26),
            SUM (a27),
            SUM (a28),
            SUM (a29),
            SUM (a30),
            SUM (a31),
            SUM (a32),
            SUM (a33),
            SUM (a34),
            SUM (a35),
            SUM (a36),
            SUM (a37),
            SUM (a38),
            SUM (a39),
            SUM (a40),
            SUM (a41),
            SUM (a42),
            SUM (a43),
            SUM (a44),
            SUM (a45),
            SUM (a46),
            SUM (a47),
            SUM (a48),
            SUM (a49),
            SUM (a50),
            SUM (a51),
            SUM (a52),
            SUM (a53),
            SUM (a54),
            SUM (a55),
            SUM (a56),
            SUM (a57),
            SUM (a58),
            SUM (a59),
            SUM (a60),
            SUM (a61),
            SUM (a62),
            SUM (a63),
            SUM (a64),
            SUM (a65),
            SUM (a66),
            SUM (a67),
            SUM (a68),
            SUM (a69),
            SUM (a70),
            SUM (a71),
            SUM (a72),
            SUM (a73),
            SUM (a74),
            SUM (a75),
            SUM (a76),
            SUM (a79),
            SUM (a80),
            YEAR,
            YEAR,
            SUM (a82),
            SUM (a83),
            SUM (a86),
            SUM (a87),
            SUM (a88),
            SUM (a89),
            SUM (a90),
            SUM (a91),
            SUM (a92),
            DECODE (SUM (a93_), 0, 0, SUM (a92) / SUM (a93_)) a93,
            SUM (a94),
            DECODE (SUM (a95_), 0, 0, SUM (a94) / SUM (a95_)) a95,
            SUM (a96),
            SUM (a97),
            SUM (a98)             --  , 'Кроме  ОПД=' || TO_CHAR(YEAR - 1) a98
                     ,
            SUM (a99),
            SUM (a100),
            SUM (a101),
            SUM (a102),
            SUM (a103),
            SUM (a104),
            SUM (a105),
            SUM (a106),
            SUM (a107),
            SUM (a108),
            SUM (a109),
            SUM (a110),
            SUM (a111),
            SUM (a112),
            SUM (a113),
            SUM (a114),
            SUM (a115),
            SUM (a116),
            SUM (a117),
            SUM (a118),
            SUM (a119),
            SUM (a120),
            SUM (a121),
            SUM (a122),
            SUM (a123),
            SUM (a124),
            SUM (a125),
            SUM (a126),
            SUM (a127),
            SUM (a128),
            SUM (a129),
            SUM (a130),
            SUM (a131),
            SUM (a132),
            -- Переоформление 2005 г. (12.04.2006 Anissimova)
            SUM (a133),
            SUM (a134),
            SUM (a135),
            SUM (a136),
            -- Переоформление 2005 г. (18.10.2006 Anissimova)
            SUM (a137),
            SUM (a138),
            SUM (a139),
            SUM (a140)                -------------- ИЗМЕНЕНИЯ февраль 2008 г.
                      ,
            SUM (a141),
            SUM (a142),
            SUM (a143),
            SUM (a144),
            SUM (a145),
            SUM (a146),
            SUM (a147),
            SUM (a148),
            SUM (a149),
            SUM (a150),
            SUM (a151),
            SUM (a152),
            SUM (a153),
            SUM (a154),
            SUM (a155),
            SUM (a156),
            SUM (a157),
            SUM (a158),
            SUM (a159),
            SUM (a160),
            SUM (a161),
            SUM (a162),
            SUM (a163),
            SUM (a108) + SUM (a110) + SUM (a119) a164,
            SUM (a108) + SUM (a110) + SUM (a119) + SUM (a40) a165,
            SUM (a166),
            SUM (a167),
            SUM (a168),
            SUM (a169),
            SUM (a170),
            SUM (a171),
            SUM (a172),
            SUM (a173),
            SUM (a174),
            SUM (a175),
            SUM (a176),
            SUM (a177),
            SUM (a178),
            SUM (a179),
            SUM (a180),
            SUM (a181),
            SUM (a182),
              SUM (a68)
            + SUM (a72)
            + SUM (a76)
            + SUM (a100)
            + SUM (a102)
            + SUM (a148)
            + SUM (a152)
            + SUM (a150)
            + SUM (a193)
            + SUM (a195)
            + SUM (a233)
               a183,
            SUM (a184),
            SUM (a185),
            SUM (a186),
            SUM (a187),
            SUM (a188),
            SUM (a189),
            SUM (a190),
            SUM (a191),
            SUM (a192),
            SUM (a193),
            SUM (a194),
            SUM (a195),
            SUM (a196),
            SUM (a197),
            SUM (a198),
            SUM (a199),
            -------------- добавил a200 - a231   AVB  29.03.2012
            SUM (a200),
            SUM (a201),
            SUM (a202),
            SUM (a203),
            SUM (a204),
            SUM (a205),
            SUM (a206),
            SUM (a207),
            SUM (a208),
            SUM (a209),
            SUM (a210),
            SUM (a211),
            SUM (a212),
            SUM (a213),
            SUM (a214),
            SUM (a215),
            SUM (a216),
            SUM (a217),
            SUM (a218),
            SUM (a219),
            SUM (a220),
            SUM (a221),
            SUM (a222),
            SUM (a223),
            SUM (a224),
            SUM (a225),
            SUM (a226),
            SUM (a227),
            SUM (a228),
            SUM (a229),
            SUM (a230),
            SUM (a231),
            SUM (a232),
            SUM (a233),
            TO_NUMBER(NVL(vl.okrug_limit,0)) as a234 --#26.04.2013
       FROM v_pl_kpu_sum_f_pr
       left join V_OKRUG_LIMIT vl on vl.okrug_id=v_pl_kpu_sum_f_pr.okrug_id and v_pl_kpu_sum_f_pr.year=vl.limit_year
   GROUP BY v_pl_kpu_sum_f_pr.okrug_id, YEAR,vl.okrug_limit
   ORDER BY okrug_id;
